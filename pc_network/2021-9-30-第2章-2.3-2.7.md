## 2.3-因特网中的电子邮件

因特网电子邮件系统由三部分组成：**用户代理** 、**邮件服务器**和**简单邮件传输**
**协议**( **Simple Mail Transfer Protocol, SMTP** )



用户代理-运行在用户端的应用程序(浏览器、邮件客户端等)



一个典型的邮件发送过程是：从发送方的用户代理开始，传输到发送方的邮件服务器，再传输到接
收方的邮件服务器，然后在这里被分发到接收方的邮箱中



![network_2_6](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_6.png)



SMTP邮件服务器既是客户端又是服务器，它使用TCP作为运输层协议



### 2.3.1-SMTP

SMTP 一般不使用中间邮件服务器发送邮件，即两个邮件服务器直接通信

端口号为25



![network_2_7](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_7.png)



使用telnet连接SMTP服务器实例

并没有验证用户过程

![network_2_8](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_8.png)

`HELO`-客户端为标识自己的身份而发送的命令（通常带域名） 正常返回250

`AUTH LOGIN`-登录到SMTP服务器，正常返回334

随后需要输入自己邮箱账户的base64编码，正常返回334

密码(qq邮箱的是授权码)的base64编码，正常返回235

`MAIL FROM:<邮箱>`-发件人，正常返回250

`RCPT TO:<邮箱>`-收件人，正常返回250

`DATA`-邮件正文，正常返回354

`.`-正文后单独一行输入表示正文结束

`QUIT`-终止会话



### 2.3.2-与HTTP 的对比

- HTTP与SMTP都使用TCP运输协议并采用持续链接

- HTTP是一个拉协议，用于获取信息
- SMTP是一个推协议，用于发送信息



### 2.3.3-邮件报文格式

即正文部分

```
From: alice@crepes.fr
To: bob@hamburger.edu
Subject: Searching for the me aning of life.

data data...
.
```

`Subject:`-为邮件主题，可选



### 2.3.4-邮件访问协议

由于取报文是一个拉操作，SMTP无法做到

使用**第三版的邮局协议-POP3**、**因特网邮件访问协议-IMAP**、**HTTP**可做到将邮件从接收方的邮件服务器传送到
接收方的用户代理

![network_2_9](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_9.png)



#### 1. POP3

POP3运行在端口110，使用TCP运输协议

建立TCP连接后， POP3 按照三个阶段进行工作：**特许** 、**事务处理**以及**更新**

**特许**-用户使用用户名和口令进行验证

**事务处理**-用户代理取回报文，可对邮件报文进行删除标记、取消删除标记、获取邮件的统计信息

**更新**-在用户使用`quit`命令结束会话后更新报文(删除被标记的报文)



在特许阶段会返回两种状态: +OK、-ERR

![network_2-10](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_10.png)



在事务处理阶段，使用命令进行邮件处理

![network_2_11](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_11.png)

`list`-列出所有报文(编号)及其长度

`retr +编号`-检索报文

`dele +编号`-删除报文

`quit`-退出并更新



#### 2.IMAP

可以在服务器上创建文件夹储存邮件还可以对文件进行分类(POP3无法做到)



#### 3. 基千Web的电子邮件

用户代理-浏览器

服务器与客户端的邮件收发都采用HTTP的形式



## 2.4-DNS因特网的目录服务

主机有两种标识方法：主机名、IP地址

IP 地址由4 个字节组成，并有着严格的层次结构



### 2.4.1-DNS提供的服务

主机名便于人们记忆，但路由器使用IP对主机进行寻址

**域名系统( Domain Name System, DNS)**提供主机名到IP地址的转换



DNS是

- 一个由分层的DNS 服务器实现的分布式数据库
- 一个使得主机能够查询分布式数据库的应用层协议

运行在53号端口，使用UDP运输协议



DNS 是为因特网上的用户应用程序以及其他软件提供一种核心功能，即将主机名转换为其背后的IP 地址



**使用浏览器请求网页的流程**

1. 同一台用户主机上运行着DNS 应用的客户端
2. 浏览器从上述URL 中抽取出主机名www. son1eschool. edu 、并将这台主机名传给DNS 应用的客户端
3. DNS 客户向DNS 服务器发送一个包含主机名的请求
4. DNS 客户最终会收到一份回答报文，其中含有对应于该主机名的IP 地址
5. 一旦浏览器接收到来自DNS 的该IP 地址，它能够向位千该IP 地址80 端口的HTTP 服务器进程发起一个TCP 连接



**DNS 还提供了一些重要的服务：**

**主机别名：**一台主机可能有一个规范主机名和一个或多个主机别名，主机别用更加容易记忆，但它们指向同一个IP，DNS能获得主机别名对应的规范主机名以及主机的IP 地址

**邮件服务器别名：**一些电子邮件地址为了便于人们记忆，使用的是别名，电子邮件应用程序可以调用DNS, 对提供的主机名别名进行解析，以获得该主机的规范主机名及其IP 地址。邮件服务器与WEB服务器可以使用同一个别名，DNS可以根据请求的类型不同进行分类。

**负载分配：**DNS可以将请求导向不同的服务器进行均匀负载



### 2.4.2-DNS工作机理概述

![network_2_12](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_12.png)

三种类型DNS服务器：根DNS服务器、顶级域DNS服务器-TLD(com、cn、org、edu为顶级域名)、权威DNS服务器

**根DNS服务器**：400 多个根名字服务器遍及全世界，这些根名字服务器由13个不同的组织管理。根名字服务器提供TLD 服务器的IP 地址

**TLD服务器**：TLD 服务器提供了权威DNS 服务器的IP 地址

**权威DNS服务器**：在因特网上具有公共可访问主机（如Web 服务器和邮件服务器）的每个组织机构必须提供公共可访问的DNS 记录，这些记录将这些主机的名字映射为IP 地址



**本地DNS 服务器**：由ISP提供，位于用户附近

当主机发出DNS 请求时，该请求被发往本地DNS服务器，它起着代理的作用



![network_2_13](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_13.png)



**DNS缓存**

改善时延性能并减少在因特网上到处传输的DNS 报文数量，被广泛使用

在一个请求链中，当某DNS服务器接收一个DNS 回答（例如，包含某主机名到IP 地址的映射）时，它能将映射缓存在本地存储器中，从而避免了请求根DNS服务器

映射并不是永久的，一般为2天丢弃



### 2.4.3-DNS记录和报文

所有DNS 服务器存储了**资源记录RR**

![network_2_14](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_14.png)



## 2.5-P2P文件分发

2016 年止，最为流行的P2P 文件分发协议是**BitTorrent**

P2P使用TCP连接

![network_2_15](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_15.png)

#### BitTorrent

参与一个特定文件分发的所有对等方的集合被称为一个**洪流(torrent)**

在一个洪流中的对等方彼此下载等长度的文件**块(chunk )** , 典型的块长度为**256KB**

每个洪流具有一个基础设施节点，称为**追踪器(tracker)**

当一个对等方加入某洪流时，它向追踪器注册自己，并周期性地通知追踪器它仍在该洪流中

![network_2_16](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_16.png)

**最稀缺优先技术：**优先在洪流中传输最稀缺的块，大致均衡洪流中每个块的副本数量

对于一个对等方A，向其传输块的速率较高的几个对等方称为**疏通**，同时A也要以较高的速率提供传输，否则其他的对等方可能将A视为**阻塞**不会再给A传输数据



## 2.6-视频流和内容分发网

### 2.6.1-因特网视频

视频是一系列的图像，视频的一个重要特征是它能够被压缩，因而可用比特率来权衡视频质量(越高越好)



### 2.6.2-HTTP流和DASH

在HTTP 流中，视频只是存储在HTTP 服务器中作为一个普通的文件，每个文件有一个特定的URL 

在客户一侧，字节被收集在客户应用缓存中， 一旦该缓存中的字节数量超过预先设定的门限，客户应用程序就开始播放



**经HTTP 的动态适应性流DASH**

视频编码为几个不同的版本，其中每个版本具有不同的比特率，对应于不同的质量水平，客户可以动态进行请求



### 2.6.3-内容分发网

- 为了应对向分布千全世界的用户分发巨量视频数据的挑战，几乎所有主要的视频流公司都利用**内容分发网**(Content Distribution Network, **CDN**)

- CDN 管理分布在多个地理位置上的服务器

- 并且所有试图将每个用户请求定向到一个将提供最好的用户体验的CDN 位置

**专用CON**-内容提供商自己所拥有

**第三方CDN**-见名知意



CDN 通常采用两种不同的服务器安置原则：

**深入：**在遍及全球的接入ISP 中部署服务器集群来深入到ISP 的接入网中。减少时延，提高吞吐量，但维护困难

**邀请做客：**将它们的集群放置在因特网交换点(IXP)，较底的维护开销，增加时延、减少吞吐量



#### CDN 操作

用户主机中的一个浏览器指令检索一个特定的视频

- 确定此时适合用于该客户的CDN 服务器集群
- 将客户的请求重定向到该集群的某台服务器

大多数CDN 利用DNS 来截获和重定向请求

![network_2_17](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_17.png)



![network_2_18](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_2_18.png)



#### 集群选择策略

任何CDN 部署，其核心是**集群选择策略**，动态地将客户定向到CDN 中的某个服务器集群或数据中心的机制

CDN一般使用**实时测量**，选择较好的服务器提供给用户



## 2.7-套接字编程：生成网络应用

具体可见我博客上的SOCKET网络编程文章

这里只说明下TCP服务端的SOCKET

**服务器SOCKET**-**欢迎SOCKET**，当有客户端连接时，响应

**连接SOCKET**-用于与客户端通信的新创建的SOCKET

