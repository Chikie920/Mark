# 第四章-网络层: 数据平面



## 4.1-网络层概述

每台路由器的**数据平面**的主要作用是从其输入链路向其输出链路转发数据报

**控制平面**的主要作用是协调这些本地的每路由器转发动作，使得数据报沿着源和目的地主机之间的路由器路径最终进行端到端传送



### 4.1.1-转发和路由选择：数据平面和控制平面

**转发：**是数据平面实现的唯一功能，是指将分组从一个输人链路接口转移到适当的输出链路接口的路由器本地动作，使用硬件实现，时间尺度小

**路由选择：**是指确定分组从源到目的地所采取的端到端路径的网络范围处理过程，使用软件实现，时间尺度大

**转发表：**路由器检查到达分组首部的一个或多个字段值，进而使用这些首部值在其转发表中索引，将分组转发到合适的出链路

**路由选择算法**决定了插入转发表的内容



#### 控制平面：SDN方法

下图是路由选择厂商在其产品中采用的传统方法，至少最近还是如此

![network_4_1](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_1.png)



将路由的数据平面与控制平面分离的方法，路由选择设备仅执行转发，而远程控制器计算并分发转发表，被称为**软件定义网络SDN**



![network_4-2](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4-2.png)



### 4.1.2-网络服务模型

因特网的网络层仅提供**尽力而为服务**，但也能服务的足够好





## 4.2-路由器工作原理



![network_4_3](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_3.png)

**输入端口：**最边缘执行物理层功能，中间执行数据链路层功能，而最内层执行查找功能-查询转发表决定输出端口，即转发决策功能在输入端实现

**交换结构：**将路由器的输入端口连接到输出端口

**输出端口：**存储交换结构接收的分组

**路由选择处理器：**执行控制平面功能。传统路由器中执行路由选择协议，维护路由选择表与关联链路状态信息，并为该路由器计算转发表；SDN路由器中负责与远程控制器通信，目的是接收由远程控制器计算的转发表项，并在该路由器的输入端口安装这些表项

以上都为硬件实现



### 4.2.1-输入端口处理和基于目的地转发

转发表是由路由选择处理器计算和更新的，转发表从路由选择处理器经过独立总线复制到线路卡，输入端口使用转发表的副本进行索引



转发表不能表示出每一种IP与其对应的转发决策，只能使用一定数量的前缀提供匹配

![network_4_4](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_4.png)

路由器用分组目的地址的**前缀**与该表中的表项进行匹配

当有多个匹配时，该路由器使用**最长前缀匹配规则**，使用最长的匹配项



### 4.2.2-交换

![network_4_5](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_5.png)

**经内存交换：**最简单、最早的路由器是传统的计算机，需要经过两次内存读写，在输入端口与输出端口之间的交换是在CPU的直接控制下完成的，系统总线一次仅能执行一个内存读写，不能同时处理两个分组，许多现代路由器也使用这种交换

**经总线交换：**输入端口经一根共享总线将分组直接传送到输出端口． 不需要CPU的干预，但总线一次也仅允许一个分组的传输

**经互联网络交换：**也称纵横式交换，有多个总线，能够并行转发多个分组，只要输入或输出端口不是一样的



### 4.2.3-输出端口处理

取出输出缓存分组并传送



### 4.2.4-何处出现排队

输入端口与输出端口都有可能出现排队



### 4.2.5-分组调度



#### 1 . 先进先出

FIFO，先到达的分组先传送



#### 2. 优先权排队

可将分组分为具有更高优先级类别，优先传输，同优先级按照FIFO

**非抢占式优先权排队：**一旦分组开始传输就不能打断



#### 3. 循环和加权公平排队



**循环排队规则**

分组被分为几类，传输一类的一个分组后传输下一个类别的分组，如果展示没有分组到达，则传输下一个类别，循环往复



**加权公平排队WFQ**

到达的分组被分类并在合适的每个类的等待区域排队

![network_4_6](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_6.png)

如循环一样每次服务一个类，类别为空则服务下一个类，与循环排队不同的是，每次对类的服务可能不止服务一个分组，每个类都被分配一个权w_i，第i类能确保收到的服务部分为`w_i/∑w_n`
