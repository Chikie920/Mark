## 4.3-网际协议：IPv4 、寻址、IPv6 及其他



### 4.3.1-IPv4 数据报格式

![network_4_7](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_7.png)

**版本字段：**规定IP协议版本，不同的版本有不同的数据报格式

**首部长度：**数据报首部长度，由于选项字段可选，长度不是一定的，需要该字段确定数据载荷位置

**服务类型：**提供特定等级服务

**数据报长度：**IP数据报总长度(字节)

**标识、标志、偏移：**与IP分片有关

**寿命：**TTL，用来确保数据报不会永远在网络中循环，每当一台路由器处理数据报时，该字段的值减1 ，若TTL字段减为0, 则该数据报必须丢弃

**协议：**表明要交付给特定的运输层协议，6-TCP，17-UDP

**首部检验和：**将首部中的每2 个字节当作一个数，用反码算术对这些数求和，类似于UDP检验和

**源和目的IP 地址：**4字节

**选项：**选项字段允许IP 首部被扩展，IPV6已移除

**数据：**有效载荷



### 4.3.2-IPv4 数据报分片

- 并不是所有链路层协议都能承载相同长度的网络层分组

- 一个链路层帧能承载的最大数据量叫作**最大传送单元MTU**，MTU 严格地限制着IP数据报的长度

- 当链路层帧无法容纳数据报时，会将数据报分片成两个或多个较小的数据报，用单独的链路层帧封装，称为**片**

- 片在其到达目的地运输层以前需要重新组装，IPv4 的设计者将数据报的重新组装工作放到端系统中

- 当生成一个数据报时，发送主机在为该数据报设置源和目的地址的同时贴上标识号, 发送主机通常将它发送的每个数据报的标识号加1当某路由器需要对一个数据报分片时， 形成的每个数据报（即片）具有初始数据报的源地址、目的地址与标识号

- 最后一个片的标志比特被设为0 、而所有其他片的标志比特被设为1

- 使用偏移字段指定该片应放在初始IP数据报的哪个位置



### 4.3.3 IPv4 编址

主机与物理链路之间的边界叫作**接口**

路由器与它的任意一条链路之间的边界也叫作接口。一台路由器因此有多个接口．每个接口有其链路

**一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联**

每个IP 地址长度为32 比特（等价为4 字节），采用**点分十进制记法**，每八位用句点隔开，每个字节用十进制表示

地址不能随意地自由选择。一个接口的IP 地址的一部分需要由其连接的子网来决定





![network_4_8](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_8.png)

上图有三个子网，每个子网都有相同的前缀，形如223.1.1.x

其前24位是相同的，该子网可表示为223.1.1.0/24，/24称为**子网掩码**，指示32 比特中的最左侧24 比特定义了子网地址

任何其他要连到223.1.1.0/24网络的主机都要求其地址具有223.1.1. XXX 的形式

**确定子网的方法**：

分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点这些隔离的网络中的每一个都叫作一个**子网**

因特网的地址分配策略被称为**无类别域间路由选择**

形式为a. b. c. d/x的地址的元最高比特构成了IP 地址的网络部分，并且经常被称为该地址的**前缀**

一个组织可使用一段具有相同前缀的IP，路由器仅需查询前缀即可确定路径，节约了转发表项

一个地址的剩余32 - x． 比特可认为是用于区分该组织内部设备的，当该组织内部的路巾器转发分组时，才会考虑这些比特

**IP 广播地址255.255.255.255**

当一台主机发出一个目的地址为255.255.255. 255 的数据报时，该报文会交付给同一个网络中的所有主机。路由器也会有选择地向邻近的子网转发该报文



#### 1 . 获取一块地址

**组织**从ISP获取一块连续地址



#### 2. 获取主机地址：动态主机配置协议

- 主机想从当前组织获取地址使用**动态主机配置协议DHCP**
- DHCP 允许主机自动获取一个IP 地址
- 网络管理员能够配置DHCP, 以使某给定主机每次与网络连接时能得到一个相同的IP 地址， 或者某主机将被分配一个临时的IP 地址

- 由于DHCP 具有将主机连接进一个网络的网络相关方面的自动能力，故它又常被称为即插即用协议或零配置协议

- 每个子网将具有一台DHCP服务器，如果在某子网中没有服务器，则需要一个DHCP 中继代理（通
  常是一台路由器），这个代理知晓用于该网络的DHCP服务器的地址

![network_4_9](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_9.png)



**DHCP协议是一个4个步骤的过程**

- **DHCP 服务器发现：**新到达的主机要获取IP需要使用UDP协议向所在网络广播**DHCP发现报文**，该报文使用源地址为0.0.0.0，目的主机地址为广播地址，目的端口号为67
- **DHCP 服务器提供：**DHCP 服务器收到一个DHCP 发现报文时，用**DHCP提供报文**响应，也是使用广播，该报文包含发现报文的事务ID 、向客户推荐的IP 地址、网络掩码以及IP 地址租用期等，一个子网中可能有多个DHCP服务器
- **DHCP 请求：**新到达的客户从一个或多个服务器提供中选择一个，并向选中的服务器提供用DHCP请求报文进行响应，回显配置的
  参数
- **DHCP ACK：**服务器用DHCP ACK 报文对DHCP 请求报文进行响应， 证实所要求的参数。

客户收到ACK即完成



### 4.3.4-网络地址转换

**网络地址转换-NAT**

NAT使能的路由器有一个接口，与设备构成一个子网

**专用网络或具有专用地址的地域：**具有专用地址的地域是指其地址仅对该网络中的设备有意义的网络，该地址仅在其子网内有意义

NAT 路由器对外界的行为就如同一个具有单一IP地址的单一设备，所有离开家庭路由器流向更大因特网的报文都拥有一个源IP 地址138. 76.29.7, 且所有进入家庭的报文都拥有同一个目的IP 地址138. 76.29.7 ，对外界隐藏了家庭网络的细节



![network_4_10](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_10.png)

NAT 路由器使用一张NAT转换表，在表项中包含了端口号及其IP 地址

NAT 已成为因特网的一个重要组件，成为所谓**中间盒**

中间盒并不执行传统的数据报转发，而是执行诸如NAT 、流蜇流的负载均衡、流量防火墙（参见下面的插入框内容）等功能



### 4.3.5-IPv6



#### 1. IPv6数据报格式

特点：

- IP地址长度扩展到128比特(16字节)
- 简化高效的40字节首部
- 流标签

![network_4_11](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_11.png)

**版本：**IPV6使用6作为版本号

**流量类型：**提供优先权服务

**下一个首部：**段标识数据报中的内容（数据字段）需要交付给哪个协议，使用与IPv4 首部中协议字段相同的值



IPv6 不允许在中间路由器上进行分片与重新组装，如果路由器收到的IPv6 数据报因太大而不能转发到出链路上的话，则路由器只需丢掉该数据报，并向发送方发回一个“分组太大”的ICMP差错报文即可

因为冗余去除了检验和字段



#### 2. 从IPv4 到IPv6 的迁移

虽然新型IP面使能系统可做成向后兼容，即能发送、路由和接收lPv4 数据报、但已部署的具有IPv4 能力的系统却不能够处理IPv6 数据报

目前使用的是**建隧道**技术

两个IPv6 节点要使用IPv6 数据报进行交互但它们是经由中间IPv4 路由器互联的。我们将两台IPv6 路巾器之间的中间IPv4 路由器的集合称为一个隧道

隧道接收端的lPv6 节点最终收到该IPv4 数据报，并确定该IPv4 数据报含有一个IPv6 数据报（通过观察在IPv4 数据报中的协议号字段是41），从中取出IPv6 数据报，然后再为该IPv6 数据报提供路由

![network_4_12](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_12.png)



## 4.4-通用转发和SON



在基于目的地转发中，通过“匹配”加“动作”来实现功能，对应SDN，这种“匹配”加“动作”变得更为通用，不仅匹配IP和执行转发



![network_4_13](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_13.png)

每台分组交换机中的一张匹配加动作表，由远程控制器计算、安装和更新。



**OpenFlow**是一个得到高度认可和成功的标准，它已经成为匹配加动作转发抽象、控制器以及更为一般的SDN 革命等概念的先驱

匹配加动作转发表在OpenFlow 中称为**流表**

- **首部宇段值的集合:**入分组将与之匹配，匹配不上流表项的分组将被丢弃或发送到远程控制器做更多处理
- **计数器集合:**当分组与流表项匹配时更新计数器
- **采取的动作集合:**丢弃、复制、转发等



### 4.4.1-匹配

OpenFlow 的匹配抽象允许对来自三个层次的协议首部所选择的字段进行匹配

![network_4_14](C:\Users\Mirai\Desktop\Work\Mark\Sources\images\network_4_14.png)



### 4.4.2-动作

重要的动作：转发、丢弃、修改首部字段



### 4.4.3-匹配加动作操作中的OpenFlow例子(看书)

